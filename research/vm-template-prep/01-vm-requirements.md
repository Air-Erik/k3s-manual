# Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ðº VM Template Ð´Ð»Ñ k3s

> **Ð­Ñ‚Ð°Ð¿:** 0 - VM Template Preparation
> **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** âœ… Ð“ÐžÐ¢ÐžÐ’Ðž
> **Ð”Ð°Ñ‚Ð°:** 2025-10-24
> **Ð¦ÐµÐ»ÑŒ:** ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ VM Template Ð´Ð»Ñ Ñ€Ð°Ð·Ð²Ñ‘Ñ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ k3s ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð°

---

## ðŸŽ¯ ÐžÐ±Ð·Ð¾Ñ€

Ð­Ñ‚Ð¾Ñ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ **Ñ‚Ð¾Ñ‡Ð½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ** Ðº VM Template Ð´Ð»Ñ k3s ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð° Ð½Ð° VMware vSphere.

### âš ï¸ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž: k3s vs Kubernetes

**k3s â€” ÑÑ‚Ð¾ ÐÐ• Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Kubernetes!**

âŒ **ÐÐ• ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°Ñ‚ÑŒ:**
- kubeadm, kubelet, kubectl
- containerd (k3s ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹!)
- Docker (Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½)
- CNI Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹ (Flannel Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½)
- Ingress ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ñ‹ (Traefik Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½)
- LoadBalancer (ServiceLB Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½)

âœ… **Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°Ñ‚ÑŒ:**
- Ubuntu 24.04 LTS (minimal)
- Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ (curl, wget, vim, net-tools)
- cloud-init Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
- open-vm-tools Ð´Ð»Ñ vSphere Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸

**ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ:** k3s â€” ÐµÐ´Ð¸Ð½Ñ‹Ð¹ Ð±Ð¸Ð½Ð°Ñ€Ð½Ð¸Ðº (~50 ÐœÐ‘), ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð¾Ð´Ð½Ð¾Ð¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹!

---

## ðŸ–¥ï¸ Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ðº VM

### Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸

| ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ | ÐžÐ±Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ |
|----------|----------|-------------|
| **OS** | Ubuntu 24.04 LTS Server (minimal) | Ð¡Ñ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð°Ñ LTS Ð²ÐµÑ€ÑÐ¸Ñ, Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° |
| **vCPU** | 2 | Ð”Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð»Ñ k3s Server + workloads |
| **RAM** | 4 GB | ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ Ð´Ð»Ñ k3s Server (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ 2+ GB) |
| **Disk** | 40 GB (thin provisioned) | ÐœÐµÑÑ‚Ð¾ Ð´Ð»Ñ OS + k3s + workloads |
| **Network** | 1 NIC | ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº NSX-T segment |

### ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°

| ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ | ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ñ |
|----------|----------|------------|
| **Firmware** | UEFI | Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° |
| **Secure Boot** | Disabled | Ð”Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ñ k3s |
| **Virtualization** | Hardware assisted | VT-x/AMD-V Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹ |
| **Memory Hot Add** | Enabled | Ð”Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ |
| **CPU Hot Add** | Enabled | Ð”Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ |

---

## ðŸ“¦ Ð¢Ñ€ÐµÐ±ÑƒÐµÐ¼Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹

### ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹

```bash
# Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹
curl                    # Ð”Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ k3s
wget                    # ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð° curl
vim                     # Ð ÐµÐ´Ð°ÐºÑ‚Ð¾Ñ€
net-tools               # ifconfig, netstat
iputils-ping            # ping
dnsutils                # nslookup, dig
htop                    # ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²
tree                    # ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³Ð¾Ð²

# Cloud-init
cloud-init              # ÐÐ²Ñ‚Ð¾ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
cloud-initramfs-growroot # Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ Ð´Ð¸ÑÐºÐ°

# VMware Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ
open-vm-tools           # VMware Tools
open-vm-tools-desktop   # GUI ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)

# Ð¡ÐµÑ‚ÐµÐ²Ñ‹Ðµ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹
iproute2                # ip ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
bridge-utils            # bridge ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
```

### ÐŸÐ°ÐºÐµÑ‚Ñ‹ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÐÐ• ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°Ñ‚ÑŒ

```bash
# Kubernetes ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ (ÐÐ• ÐÐ£Ð–ÐÐ«!)
kubeadm                 # k3s Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚
kubelet                 # k3s ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹
kubectl                 # k3s ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹
kubernetes-cni          # k3s ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ CNI

# Container runtime (ÐÐ• ÐÐ£Ð–ÐÐ«!)
containerd              # k3s ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹
docker.io               # k3s Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Docker
docker-ce               # k3s Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Docker
cri-o                   # k3s Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚

# CNI Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹ (ÐÐ• ÐÐ£Ð–ÐÐ«!)
flannel                 # k3s ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ Flannel
calico                  # k3s Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Flannel Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
cilium                  # k3s Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Flannel Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ

# Ingress ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ñ‹ (ÐÐ• ÐÐ£Ð–ÐÐ«!)
nginx-ingress           # k3s ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ Traefik
traefik                 # k3s ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ Traefik

# LoadBalancer (ÐÐ• ÐÐ£Ð–ÐÐ«!)
metallb                 # k3s ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ ServiceLB
kube-vip                # k3s ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ ServiceLB
```

---

## âš™ï¸ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸

### ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑÐ´Ñ€Ð° (ÐÐ• Ð½ÑƒÐ¶Ð½Ñ‹ Ð´Ð»Ñ k3s!)

**Ð’ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾Ñ‚ "Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾" Kubernetes, k3s ÐÐ• Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚:**

```bash
# ÐÐ• Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹!
# net.bridge.bridge-nf-call-iptables = 1
# net.ipv4.ip_forward = 1
# net.ipv4.conf.all.forwarding = 1
# vm.swappiness = 0
# kernel.panic = 10
# kernel.panic_on_oops = 1
```

**ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ:** k3s Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÑ‚ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ´Ñ€Ð° Ð¿Ñ€Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ!

### ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑÐµÑ‚Ð¸

```bash
# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° cloud-init Ð´Ð»Ñ VMware vSphere
sudo tee /etc/cloud/cloud.cfg.d/98-datasource.cfg >/dev/null <<'YAML'
datasource_list: [ VMware, OVF, NoCloud, None ]
YAML

# Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ cloud-init ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
sudo systemctl unmask cloud-init cloud-init-local cloud-config cloud-final
sudo systemctl enable cloud-init cloud-init-local cloud-config cloud-final

# Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ñ… netplan-Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ 50-cloud-init.yaml
sudo rm -f /etc/netplan/*.yaml

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ cloud-init Ð´Ð»Ñ Template
sudo cloud-init clean --logs --machine
sudo rm -rf /var/lib/cloud
```

### ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸

```bash
# SSH Ð´Ð¾ÑÑ‚ÑƒÐ¿
Port 22
PermitRootLogin no
PasswordAuthentication yes
PubkeyAuthentication yes

# Firewall (Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹)
ufw allow ssh
ufw allow 6443/tcp    # k3s API Server
ufw allow 10250/tcp   # kubelet
ufw allow 8472/udp    # Flannel VXLAN
```

---

## ðŸ”§ Cloud-init ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ

### Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ

```yaml
# ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÐµÐºÑ†Ð¸Ð¸ cloud-init
hostname: [ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð¼Ñ Ð½Ð¾Ð´Ñ‹]
fqdn: [hostname]

# ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ
users:
  - name: k8s-admin
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    passwd: [Ñ…ÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ]

# Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ IP
write_files:
  - path: /etc/netplan/01-static-ip.yaml
    content: |
      network:
        version: 2
        ethernets:
          ens192:
            addresses: [IP/24]
            routes:
              - to: default
                via: 10.246.10.1
            nameservers:
              addresses: [172.17.10.3, 8.8.8.8]

# ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¿Ð¾ÑÐ»Ðµ boot
runcmd:
  - netplan apply
  - systemctl restart systemd-networkd
```

---

## ðŸŒ Ð¡ÐµÑ‚ÐµÐ²Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ

### NSX-T Segment

| ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |
|----------|----------|
| **Segment** | k8s-zeon-dev-segment |
| **CIDR** | 10.246.10.0/24 |
| **Gateway** | 10.246.10.1 |
| **DNS** | 172.17.10.3, 8.8.8.8 |

### IP Allocation Ð´Ð»Ñ k3s

| ÐÐ¾Ð´Ð° | IP | Hostname | ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |
|------|----|---------|-----------|
| Server | 10.246.10.50 | k3s-server-01 | API Server + etcd + workloads |
| Agent 1 | 10.246.10.51 | k3s-agent-01 | Worker node |
| Agent 2 | 10.246.10.52 | k3s-agent-02 | Worker node |

### ÐŸÐ¾Ñ€Ñ‚Ñ‹ k3s

| ÐŸÐ¾Ñ€Ñ‚ | ÐŸÑ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð» | ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |
|------|----------|------------|
| 6443 | TCP | k3s API Server |
| 10250 | TCP | kubelet |
| 8472 | UDP | Flannel VXLAN |
| 2379-2380 | TCP | etcd (ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ) |

---

## ðŸ” Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ

### SSH ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ

```bash
# ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ
User: k8s-admin
Password: admin (Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ð¾Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸)
SSH Key: ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ (Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ)

# SSH Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
Port 22
PermitRootLogin no
PasswordAuthentication yes
PubkeyAuthentication yes
```

### Firewall (Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹)

```bash
# Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿Ð¾Ñ€Ñ‚Ñ‹
ufw allow ssh
ufw allow 6443/tcp    # k3s API
ufw allow 10250/tcp   # kubelet
ufw allow 8472/udp    # Flannel
ufw --force enable
```

---

## ðŸ“Š Ð ÐµÑÑƒÑ€ÑÑ‹ Ð¿Ð¾ Ð½Ð¾Ð´Ð°Ð¼

### Server Node (k3s-server-01)

| Ð ÐµÑÑƒÑ€Ñ | ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ | Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ | ÐžÐ±Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ |
|--------|---------|---------------|-------------|
| vCPU | 2 | 4 | API Server + etcd + scheduler |
| RAM | 2 GB | 4 GB | etcd + API Server + workloads |
| Disk | 20 GB | 40 GB | OS + etcd + logs |

### Agent Nodes (k3s-agent-01, k3s-agent-02)

| Ð ÐµÑÑƒÑ€Ñ | ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ | Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ | ÐžÐ±Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ |
|--------|---------|---------------|-------------|
| vCPU | 2 | 4 | Workloads + kubelet |
| RAM | 1 GB | 2 GB | Workloads + kubelet |
| Disk | 20 GB | 40 GB | OS + workloads + logs |

---

## âœ… ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Template

Template ÑÑ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¼ ÐºÐ¾Ð³Ð´Ð°:

1. **OS ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°:** Ubuntu 24.04 LTS (minimal)
2. **ÐŸÐ°ÐºÐµÑ‚Ñ‹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹:** Ð’ÑÐµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
3. **Cloud-init Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½:** Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ð°Ð²Ñ‚Ð¾ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
4. **VMware Tools:** open-vm-tools ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
5. **Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ð°:** Ð›Ð¾Ð³Ð¸, history, SSH keys, machine-id
6. **Ð‘ÐµÐ· K8s ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²:** ÐÐ¸ÐºÐ°ÐºÐ¸Ñ… kubeadm, kubelet, kubectl, containerd
7. **Ð“Ð¾Ñ‚Ð¾Ð² Ðº ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ:** ÐœÐ¾Ð¶Ð½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ VM Ð¸Ð· Template

---

## ðŸš« Ð§Ñ‚Ð¾ ÐÐ• Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð² Template

### Ð—Ð°Ð¿Ñ€ÐµÑ‰Ñ‘Ð½Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹

```bash
# Kubernetes ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹
kubeadm kubelet kubectl kubernetes-cni

# Container runtime
containerd docker.io docker-ce cri-o

# CNI Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹
flannel calico cilium

# Ingress ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ñ‹
nginx-ingress traefik

# LoadBalancer
metallb kube-vip

# Ð¡Ð¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ K8s
sysctl Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ K8s
Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ swap
Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ ÑÐ´Ñ€Ð°
```

### Ð—Ð°Ð¿Ñ€ÐµÑ‰Ñ‘Ð½Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸

```bash
# ÐÐ• Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ñ‚ÑŒ swap
# ÐÐ• Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒ swap
# ÐÐ• Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ñ‚ÑŒ sysctl Ð´Ð»Ñ K8s
# ÐÐ• Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°Ñ‚ÑŒ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ ÑÐ´Ñ€Ð°
# ÐÐ• Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ñ‚ÑŒ CNI
# ÐÐ• Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ñ‚ÑŒ CRI
```

---

## ðŸ“‹ Ð§ÐµÐº-Ð»Ð¸ÑÑ‚ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸

### ÐŸÐµÑ€ÐµÐ´ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð°Ñ†Ð¸ÐµÐ¹ Ð² Template

- [ ] Ubuntu 24.04 LTS ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ (minimal)
- [ ] Ð’ÑÐµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹
- [ ] Cloud-init Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¸ Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½
- [ ] open-vm-tools ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
- [ ] SSH Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ (k8s-admin:admin)
- [ ] Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð° (apt update && apt upgrade)
- [ ] Ð›Ð¾Ð³Ð¸ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ñ‹
- [ ] History Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½
- [ ] SSH keys ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹
- [ ] Machine-id ÑÐ±Ñ€Ð¾ÑˆÐµÐ½
- [ ] ÐÐ•Ð¢ kubeadm, kubelet, kubectl, containerd
- [ ] ÐÐ•Ð¢ Docker
- [ ] ÐÐ•Ð¢ CNI Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²
- [ ] ÐÐ•Ð¢ Ingress ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ð¾Ð²
- [ ] ÐÐ•Ð¢ LoadBalancer ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²

### ÐŸÐ¾ÑÐ»Ðµ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð°Ñ†Ð¸Ð¸ Ð² Template

- [ ] Template ÑÐ¾Ð·Ð´Ð°Ð½: `k3s-ubuntu2404-minimal-template`
- [ ] Ð¢ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾
- [ ] Cloud-init Ð¾Ñ‚Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾
- [ ] Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ IP Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½
- [ ] DNS Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
- [ ] Ð˜Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
- [ ] SSH Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
- [ ] Hostname ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾

---

## ðŸŽ¯ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸

1. **Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ VM Ð² vSphere** Ð¿Ð¾ ÑÑ‚Ð¸Ð¼ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸ÑÐ¼
2. **Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ubuntu 24.04 LTS** (minimal)
3. **Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸** (Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð² Ð­Ñ‚Ð°Ð¿Ðµ 3)
4. **ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Template** (Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð² Ð­Ñ‚Ð°Ð¿Ðµ 5)
5. **Ð’Ð°Ð»Ð¸Ð´Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Template** (Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð² Ð­Ñ‚Ð°Ð¿Ðµ 6)

---

**Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾:** 2025-10-24
**AI-Ð°Ð³ÐµÐ½Ñ‚:** VM Template Specialist
**Ð¦ÐµÐ»ÑŒ:** ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ VM Template Ð´Ð»Ñ k3s Ð±ÐµÐ· K8s ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
