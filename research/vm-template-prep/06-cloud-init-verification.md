# Ð’ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ cloud-init Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° VM

> **Ð­Ñ‚Ð°Ð¿:** 0 - VM Template Preparation
> **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** âœ… Ð“ÐžÐ¢ÐžÐ’Ðž
> **Ð”Ð°Ñ‚Ð°:** 2025-10-24
> **Ð¦ÐµÐ»ÑŒ:** Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ cloud-init Ð½Ð° ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… VM

---

## ðŸŽ¯ ÐžÐ±Ð·Ð¾Ñ€

Ð­Ñ‚Ð¾Ñ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ **Ð¿Ð¾ÑˆÐ°Ð³Ð¾Ð²ÑƒÑŽ Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ñƒ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸** cloud-init Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° VM Ð¸Ð· Template. ÐŸÐ¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ ÑƒÐ±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾.

### âš ï¸ Ð’Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°

- **Ð¦ÐµÐ»ÑŒ:** Ð£Ð±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ Ñ‡Ñ‚Ð¾ cloud-init Ð¾Ñ‚Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ
- **Ð’Ñ€ÐµÐ¼Ñ:** ~10 Ð¼Ð¸Ð½ÑƒÑ‚ Ð½Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ
- **Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:** VM Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ k3s

---

## ðŸ“‹ ÐŸÑ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ

### Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ VM

- âœ… **VM ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°** Ð¸Ð· Template
- âœ… **Cloud-init Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½** Ð² vSphere UI
- âœ… **VM Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°** Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»Ð°ÑÑŒ
- âœ… **SSH Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½** (k3s-admin:admin)

### ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ

- **IP Ð°Ð´Ñ€ÐµÑ VM:** 10.246.10.50/51/52
- **ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ:** k3s-admin
- **ÐŸÐ°Ñ€Ð¾Ð»ÑŒ:** admin
- **Ð’Ñ€ÐµÐ¼Ñ:** ~10 Ð¼Ð¸Ð½ÑƒÑ‚

---

## ðŸ”§ ÐŸÐ¾ÑˆÐ°Ð³Ð¾Ð²Ð°Ñ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ

### Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº VM

```bash
# SSH Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº VM
ssh k3s-admin@10.246.10.50
# ÐŸÐ°Ñ€Ð¾Ð»ÑŒ: admin

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾
whoami
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ: k3s-admin

pwd
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ: /home/k3s-admin
```

### Ð¨Ð°Ð³ 2: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° cloud-init

#### 2.1 ÐžÐ±Ñ‰Ð¸Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° cloud-init
cloud-init status
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ: done

# Ð•ÑÐ»Ð¸ Ð½Ðµ done, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸
cloud-init status --long
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð²Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÑÑ‚Ð°Ð¿Ð°
```

#### 2.2 ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð² cloud-init

```bash
# ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð»Ð¾Ð³Ð¸ cloud-init
sudo cat /var/log/cloud-init.log | tail -20
# Ð˜Ñ‰Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸

# Ð›Ð¾Ð³Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÑÑ‚Ð°Ð¿Ð°
sudo cat /var/log/cloud-init-output.log | tail -20
# Ð”Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´

# Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð»Ð¾Ð³Ð¸
sudo journalctl -u cloud-init
sudo journalctl -u cloud-init-local
sudo journalctl -u cloud-config
sudo journalctl -u cloud-final
```

### Ð¨Ð°Ð³ 3: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ‚ÐµÐ²Ñ‹Ñ… Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº

#### 3.1 ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° IP Ð°Ð´Ñ€ÐµÑÐ°

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ‚ÐµÐ²Ñ‹Ñ… Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ¾Ð²
ip addr show
# Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼ IP

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ IP
ip addr show | grep "10.246.10"
# Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð²Ð°Ñˆ IP (50, 51, Ð¸Ð»Ð¸ 52)

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° netplan ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
cat /etc/netplan/50-cloud-init.yaml
# Ð”Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑÐµÑ‚Ð¸
```

#### 3.2 ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
ip route
# Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ default route Ñ‡ÐµÑ€ÐµÐ· 10.246.10.1

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° gateway
ping -c 3 10.246.10.1
# Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ ping
```

#### 3.3 ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° DNS

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° DNS Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº
cat /etc/resolv.conf
# Ð”Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ: 172.17.10.3, 8.8.8.8

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° DNS Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
nslookup google.com
# Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ IP Ð°Ð´Ñ€ÐµÑ

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ð°
ping -c 3 8.8.8.8
# Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ ping
```

### Ð¨Ð°Ð³ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° hostname

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° hostname
hostname
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ: k3s-server-01, k3s-agent-01, Ð¸Ð»Ð¸ k3s-agent-02

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð°Ð¹Ð»Ð° hostname
cat /etc/hostname
# Ð”Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ hostname

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° /etc/hosts
cat /etc/hosts
# Ð”Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ Ñ hostname Ð¸ IP
```

### Ð¨Ð°Ð³ 5: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ

#### 5.1 ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½
id k3s-admin
# Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð³Ñ€ÑƒÐ¿Ð¿ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
groups k3s-admin
# Ð”Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ð° sudo

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° sudo Ð¿Ñ€Ð°Ð²
sudo -l
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° sudo
```

#### 5.2 ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSH ÐºÐ»ÑŽÑ‡ÐµÐ¹

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSH ÐºÐ»ÑŽÑ‡ÐµÐ¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
ls -la ~/.ssh/
# Ð”Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ authorized_keys (ÐµÑÐ»Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹)

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSH ÐºÐ»ÑŽÑ‡ÐµÐ¹ Ñ…Ð¾ÑÑ‚Ð°
sudo ls -la /etc/ssh/ssh_host_*
# Ð”Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ SSH ÐºÐ»ÑŽÑ‡Ð¸ (rsa, ecdsa, ed25519)
```

### Ð¨Ð°Ð³ 6: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ñ‹Ñ… ÐºÐ¾Ð¼Ð°Ð½Ð´

#### 6.1 ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ k3s-setup
ls -la /opt/k3s-setup
# Ð”Ð¾Ð»Ð¶Ð½Ð° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸ Ð¿Ñ€Ð¸Ð½Ð°Ð´Ð»ÐµÐ¶Ð°Ñ‚ÑŒ k3s-admin

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² Ð½Ð° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
ls -la /opt/ | grep k3s-setup
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ: drwxr-xr-x k3s-admin k3s-admin
```

#### 6.2 ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° firewall

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° firewall
sudo ufw status
# Ð”Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð´Ð»Ñ SSH Ð¸ k3s Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ñ… Ð¿Ñ€Ð°Ð²Ð¸Ð»
sudo ufw status | grep -E "(ssh|6443|10250|8472)"
# Ð”Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°
```

### Ð¨Ð°Ð³ 7: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¸ Ð»Ð¾ÐºÐ°Ð»Ð¸

#### 7.1 ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
date
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ð°ÑÐ¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾ÑÑÐ°
timedatectl
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ: UTC

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° NTP
sudo systemctl status systemd-timesyncd
# Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½
```

#### 7.2 ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾ÐºÐ°Ð»Ð¸

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾ÐºÐ°Ð»Ð¸
locale
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ: en_US.UTF-8

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ð»Ð¾ÐºÐ°Ð»ÐµÐ¹
locale -a | grep en_US
# Ð”Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ en_US.UTF-8
```

---

## ðŸš¨ Troubleshooting Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° 1: Cloud-init Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ñ‘Ð½ (status: disabled)

#### Ð¡Ð¸Ð¼Ð¿Ñ‚Ð¾Ð¼Ñ‹:
- `cloud-init status` Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ "disabled"
- Ð¡ÐµÑ‚ÐµÐ²Ð¾Ð¹ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð² ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸ DOWN
- ÐÐµÑ‚ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð² (ip route Ð¿ÑƒÑÑ‚Ð¾Ð¹)
- ÐÐµÑ‚ IP Ð°Ð´Ñ€ÐµÑÐ°

#### Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°:
```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
cloud-init status
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ: done (Ð½Ðµ disabled)

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ‚ÐµÐ²Ñ‹Ñ… Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ¾Ð²
ip addr show
# Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð² ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸ UP

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
ip route
# Ð”Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
```

#### Ð ÐµÑˆÐµÐ½Ð¸Ðµ 1: ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ
```bash
# Ð—Ð°Ð¿ÑƒÑÐº ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
./scripts/fix-cloud-init-vmware.sh
```

#### Ð ÐµÑˆÐµÐ½Ð¸Ðµ 2: Ð ÑƒÑ‡Ð½Ð¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ
```bash
# ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž: Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ cloud-init Ð´Ð»Ñ VMware
# Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð² cloud.cfg
echo "disable_vmware_customization: false" | sudo tee -a /etc/cloud/cloud.cfg

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
grep "disable_vmware_customization" /etc/cloud/cloud.cfg
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ: disable_vmware_customization: false

# Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ cloud-init
sudo systemctl unmask cloud-init cloud-init-local cloud-config cloud-final
sudo systemctl enable cloud-init cloud-init-local cloud-config cloud-final
sudo systemctl start cloud-init

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð´Ð»Ñ VMware
sudo tee /etc/cloud/cloud.cfg.d/99-vmware.cfg > /dev/null << 'EOF'
disable_vmware_customization: false
datasource:
  VMware:
    metadata_urls: ['http://169.254.169.254']
    max_wait: 10
    timeout: 5
network:
  config: enabled
EOF

# Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ‚Ð¸
sudo rm -f /etc/netplan/*.yaml
sudo netplan apply
sudo systemctl restart systemd-networkd

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº cloud-init
sudo cloud-init clean --logs --machine
sudo rm -rf /var/lib/cloud
sudo cloud-init init
```

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° 2: Ð¡ÐµÑ‚ÑŒ Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°

#### Ð¡Ð¸Ð¼Ð¿Ñ‚Ð¾Ð¼Ñ‹:
- IP Ð°Ð´Ñ€ÐµÑ Ð½Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½
- ÐÐµÑ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ñƒ
- DNS Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚

#### Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°:
```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° netplan
sudo netplan status
sudo netplan try

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ‚ÐµÐ²Ñ‹Ñ… Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ¾Ð²
ip addr show
ip route
```

#### Ð ÐµÑˆÐµÐ½Ð¸Ðµ:
```bash
# ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑÐµÑ‚ÐµÐ²Ñ‹Ñ… Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº
sudo netplan apply
sudo systemctl restart systemd-networkd

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°
ip addr show
ping -c 3 8.8.8.8
```

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° 3: ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½

#### Ð¡Ð¸Ð¼Ð¿Ñ‚Ð¾Ð¼Ñ‹:
- ÐÐµ ÑƒÐ´Ð°Ñ‘Ñ‚ÑÑ Ð²Ð¾Ð¹Ñ‚Ð¸ ÐºÐ°Ðº k3s-admin
- ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð½Ðµ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ÑÑ
- ÐÐµÑ‚ sudo Ð¿Ñ€Ð°Ð²

#### Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°:
```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
id k3s-admin
sudo passwd -S k3s-admin

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð³Ñ€ÑƒÐ¿Ð¿
groups k3s-admin
```

#### Ð ÐµÑˆÐµÐ½Ð¸Ðµ:
```bash
# Ð ÑƒÑ‡Ð½Ð¾Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
sudo useradd -m -s /bin/bash k3s-admin
sudo usermod -aG sudo k3s-admin
echo 'k3s-admin:admin' | sudo chpasswd

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°
id k3s-admin
```

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° 4: SSH Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½

#### Ð¡Ð¸Ð¼Ð¿Ñ‚Ð¾Ð¼Ñ‹:
- ÐÐµ ÑƒÐ´Ð°Ñ‘Ñ‚ÑÑ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ð¿Ð¾ SSH
- Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
- ÐžÑ‚ÐºÐ°Ð· Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ðµ

#### Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°:
```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSH ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
sudo systemctl status ssh
sudo netstat -tlnp | grep :22
```

#### Ð ÐµÑˆÐµÐ½Ð¸Ðµ:
```bash
# Ð—Ð°Ð¿ÑƒÑÐº SSH
sudo systemctl enable ssh
sudo systemctl start ssh

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° firewall
sudo ufw status
sudo ufw allow ssh
```

---

## âœ… Ð§ÐµÐº-Ð»Ð¸ÑÑ‚ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸

### ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸:

- [ ] **Cloud-init ÑÑ‚Ð°Ñ‚ÑƒÑ:** `done`
- [ ] **Ð¡ÐµÑ‚ÑŒ:** IP Ð°Ð´Ñ€ÐµÑ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾
- [ ] **ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹:** Default route Ñ‡ÐµÑ€ÐµÐ· 10.246.10.1
- [ ] **DNS:** Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ (nslookup google.com)
- [ ] **Ð˜Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚:** Ð”Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ (ping 8.8.8.8)
- [ ] **Hostname:** Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾
- [ ] **ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ:** k3s-admin ÑÐ¾Ð·Ð´Ð°Ð½
- [ ] **SSH:** Ð”Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ (k3s-admin:admin)
- [ ] **Sudo:** ÐŸÑ€Ð°Ð²Ð° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹
- [ ] **Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸:** /opt/k3s-setup ÑÐ¾Ð·Ð´Ð°Ð½Ð°
- [ ] **Firewall:** ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹
- [ ] **Ð’Ñ€ÐµÐ¼Ñ:** UTC, NTP Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
- [ ] **Ð›Ð¾ÐºÐ°Ð»ÑŒ:** en_US.UTF-8

### Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸:

- [ ] **SSH ÐºÐ»ÑŽÑ‡Ð¸:** ÐÐ¾Ð²Ñ‹Ðµ ÐºÐ»ÑŽÑ‡Ð¸ Ñ…Ð¾ÑÑ‚Ð° ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹
- [ ] **Ð›Ð¾Ð³Ð¸:** ÐÐµÑ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð² cloud-init Ð»Ð¾Ð³Ð°Ñ…
- [ ] **Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹:** Ð’ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹
- [ ] **ÐŸÑ€Ð°Ð²Ð°:** ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸

---

## ðŸŽ¯ ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¸ ÑƒÑÐ¿ÐµÑ…Ð°

### VM ÑÑ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾Ð¹ ÐºÐ¾Ð³Ð´Ð°:

1. **Ð’ÑÐµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹** âœ…
2. **Cloud-init Ð¾Ñ‚Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ** âœ…
3. **Ð¡ÐµÑ‚ÑŒ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð° ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾** âœ…
4. **ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ k3s-admin Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½** âœ…
5. **SSH Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚** âœ…
6. **ÐÐµÑ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð² Ð»Ð¾Ð³Ð°Ñ…** âœ…

### Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:

1. **Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° k3s** Ð½Ð° Server Ð½Ð¾Ð´Ñƒ
2. **ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Agent Ð½Ð¾Ð´** Ðº ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ñƒ
3. **ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° vSphere CSI**
4. **Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð°**

---

## ðŸ“Š ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ð¾ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸

### Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°:

```bash
# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð° Ð¾ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
cat > /tmp/cloud-init-verification-report.txt << 'EOF'
# ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ð¾ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ cloud-init
# Ð”Ð°Ñ‚Ð°: $(date)
# VM: $(hostname)
# IP: $(ip route get 8.8.8.8 | awk '{print $7}')

## Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº

### Cloud-init ÑÑ‚Ð°Ñ‚ÑƒÑ
- Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: $(cloud-init status)
- Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ: $(cloud-init status --long | grep "finished")

### Ð¡ÐµÑ‚ÑŒ
- IP Ð°Ð´Ñ€ÐµÑ: $(ip addr show | grep "10.246.10" | awk '{print $2}')
- Gateway: $(ip route | grep default | awk '{print $3}')
- DNS: $(cat /etc/resolv.conf | grep nameserver | wc -l) ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²

### ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ
- ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: $(whoami)
- Sudo Ð¿Ñ€Ð°Ð²Ð°: $(sudo -l | wc -l) Ð¿Ñ€Ð°Ð²Ð¸Ð»
- SSH Ð´Ð¾ÑÑ‚ÑƒÐ¿: $(systemctl is-active ssh)

### Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°
- Hostname: $(hostname)
- Ð’Ñ€ÐµÐ¼Ñ: $(date)
- Ð›Ð¾ÐºÐ°Ð»ÑŒ: $(locale | grep LANG)

### Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
- Cloud-init: [ÑƒÑÐ¿ÐµÑˆÐ½Ð¾/Ð¾ÑˆÐ¸Ð±ÐºÐ°]
- Ð¡ÐµÑ‚ÑŒ: [Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚/Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚]
- ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: [ÑÐ¾Ð·Ð´Ð°Ð½/Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½]
- SSH: [Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½/Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½]
- Ð“Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚ÑŒ: [Ð³Ð¾Ñ‚Ð¾Ð²Ð°/Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð°]
EOF

echo "ÐžÑ‚Ñ‡Ñ‘Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½: /tmp/cloud-init-verification-report.txt"
```

---

**Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾:** 2025-10-24
**AI-Ð°Ð³ÐµÐ½Ñ‚:** VM Template Specialist
**Ð¦ÐµÐ»ÑŒ:** Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ cloud-init
