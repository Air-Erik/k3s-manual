# Валидация Template для k3s

> **Этап:** 0 - VM Template Preparation
> **Статус:** ✅ ГОТОВО
> **Дата:** 2025-10-24
> **Цель:** Комплексная валидация Template для k3s кластера

---

## 🎯 Обзор

Этот документ содержит **комплексную процедуру валидации** Template для k3s кластера. Валидация включает тестирование всех компонентов и функций.

### ⚠️ Важно для оператора

- **Предварительно:** Template должен быть создан и готов к клонированию
- **Цель:** Убедиться что Template работает корректно для всех k3s нод
- **Время:** ~15 минут

---

## 📋 Предварительные требования

### Состояние Template

- ✅ **Template создан:** `k3s-ubuntu2404-template-vm`
- ✅ **Находится в разделе Templates**
- ✅ **Настройки корректны** (vCPU, RAM, Disk, Network)
- ✅ **Готов к клонированию**

### Необходимые данные

- **Template:** k3s-ubuntu2404-template-vm
- **Network:** k8s-zeon-dev-segment (10.246.10.0/24)
- **Cloud-init файлы:** Готовы для использования
- **Время:** ~15 минут

---

## 🔧 Процедура валидации

### Шаг 1: Подготовка к тестированию

#### 1.1 Создание тестовых VM

Создайте **3 тестовые VM** из Template для проверки всех типов нод:

**VM 1: Server нода (тест)**
- **Name:** `k3s-server-test`
- **IP:** 10.246.10.50 (временно)
- **Hostname:** k3s-server-test
- **Cloud-init:** server-node.yaml

**VM 2: Agent нода 1 (тест)**
- **Name:** `k3s-agent-test-01`
- **IP:** 10.246.10.51 (временно)
- **Hostname:** k3s-agent-test-01
- **Cloud-init:** agent-node-01.yaml

**VM 3: Agent нода 2 (тест)**
- **Name:** `k3s-agent-test-02`
- **IP:** 10.246.10.52 (временно)
- **Hostname:** k3s-agent-test-02
- **Cloud-init:** agent-node-02.yaml

#### 1.2 Настройка cloud-init

Для каждой тестовой VM:

1. **Скопируйте соответствующий cloud-init файл**
2. **Замените хэш пароля** на реальный (используйте `scripts/generate-password-hash.sh`)
3. **Настройте cloud-init** в vSphere UI

### Шаг 2: Запуск тестовых VM

#### 2.1 Последовательный запуск

1. **Запустите VM 1:** `k3s-server-test`
2. **Дождитесь** завершения cloud-init (~2-3 минуты)
3. **Запустите VM 2:** `k3s-agent-test-01`
4. **Дождитесь** завершения cloud-init (~2-3 минуты)
5. **Запустите VM 3:** `k3s-agent-test-02`
6. **Дождитесь** завершения cloud-init (~2-3 минуты)

#### 2.2 Проверка статуса

```bash
# Для каждой VM проверьте:
# 1. VM запустилась
# 2. Cloud-init завершился
# 3. Сеть настроена
# 4. SSH доступен
```

---

## ✅ Комплексная валидация

### Шаг 3: Валидация Server ноды (k3s-server-test)

#### 3.1 Подключение к VM

```bash
# SSH подключение
ssh k8s-admin@10.246.10.50
# Пароль: admin
```

#### 3.2 Проверка cloud-init

```bash
# Проверка статуса cloud-init
cloud-init status
# Должно быть: done

# Проверка логов cloud-init
cat /var/log/cloud-init.log | tail -20
# Должны быть сообщения об успешном завершении

# Проверка времени выполнения
cloud-init status --long
# Должно показать время выполнения
```

#### 3.3 Проверка сетевых настроек

```bash
# Проверка IP адреса
ip addr show ens192
# Должен быть: 10.246.10.50/24

# Проверка маршрутов
ip route
# Должен быть default route через 10.246.10.1

# Проверка DNS
cat /etc/resolv.conf
# Должны быть: 172.17.10.3, 8.8.8.8

# Проверка hostname
hostname
# Должно быть: k3s-server-test

cat /etc/hostname
# Должно быть: k3s-server-test
```

#### 3.4 Проверка подключения

```bash
# Проверка интернета
ping -c 3 8.8.8.8
# Должен быть успешный ping

# Проверка DNS
nslookup google.com
# Должен вернуть IP адрес

# Проверка gateway
ping -c 3 10.246.10.1
# Должен быть успешный ping
```

#### 3.5 Проверка системных компонентов

```bash
# Проверка SSH
sudo systemctl status ssh
# Должен быть: active (running)

# Проверка VMware Tools
sudo systemctl status open-vm-tools
# Должен быть: active (running)

# Проверка firewall
sudo ufw status
# Должны быть правила для SSH, 6443, 10250, 8472, 2379-2380

# Проверка установленных пакетов
dpkg -l | grep -E "(curl|wget|vim|cloud-init|open-vm-tools)"
# Все пакеты должны быть установлены
```

#### 3.6 Проверка отсутствия K8s компонентов

```bash
# Проверка что НЕТ k8s компонентов
dpkg -l | grep -E "(kubeadm|kubelet|kubectl|containerd|docker)"
# Должно быть пусто

# Проверка что НЕТ CNI плагинов
dpkg -l | grep -E "(flannel|calico|cilium)"
# Должно быть пусто

# Проверка что НЕТ Ingress контроллеров
dpkg -l | grep -E "(nginx-ingress|traefik)"
# Должно быть пусто
```

### Шаг 4: Валидация Agent нод

#### 4.1 Agent нода 1 (k3s-agent-test-01)

```bash
# SSH подключение
ssh k8s-admin@10.246.10.51
# Пароль: admin

# Проверка IP
ip addr show ens192
# Должен быть: 10.246.10.51/24

# Проверка hostname
hostname
# Должно быть: k3s-agent-test-01

# Проверка подключения к Server
ping -c 3 10.246.10.50
# Должен быть успешный ping

# Проверка интернета
ping -c 3 8.8.8.8
# Должен быть успешный ping
```

#### 4.2 Agent нода 2 (k3s-agent-test-02)

```bash
# SSH подключение
ssh k8s-admin@10.246.10.52
# Пароль: admin

# Проверка IP
ip addr show ens192
# Должен быть: 10.246.10.52/24

# Проверка hostname
hostname
# Должно быть: k3s-agent-test-02

# Проверка подключения к Server
ping -c 3 10.246.10.50
# Должен быть успешный ping

# Проверка интернета
ping -c 3 8.8.8.8
# Должен быть успешный ping
```

### Шаг 5: Валидация сетевой связности

#### 5.1 Проверка связности между нодами

```bash
# С Server ноды (10.246.10.50):
ping -c 3 10.246.10.51  # Agent 1
ping -c 3 10.246.10.52  # Agent 2

# С Agent ноды 1 (10.246.10.51):
ping -c 3 10.246.10.50  # Server
ping -c 3 10.246.10.52  # Agent 2

# С Agent ноды 2 (10.246.10.52):
ping -c 3 10.246.10.50  # Server
ping -c 3 10.246.10.51  # Agent 1
```

#### 5.2 Проверка портов k3s

```bash
# На Server ноде проверьте что порты открыты:
sudo netstat -tlnp | grep -E "(6443|10250|8472|2379|2380)"
# Должны быть порты (после установки k3s)

# На Agent нодах проверьте что порты открыты:
sudo netstat -tlnp | grep -E "(10250|8472)"
# Должны быть порты (после установки k3s)
```

---

## 📊 Отчёт о валидации

### Шаг 6: Создание отчёта

Создайте отчёт о результатах валидации:

```bash
# На любой ноде создайте отчёт
cat > /tmp/validation-report.txt << 'EOF'
# Отчёт о валидации Template для k3s
# Дата: $(date)

## Результаты валидации

### Server нода (k3s-server-test)
- IP: 10.246.10.50
- Hostname: k3s-server-test
- Cloud-init: [результат]
- Сеть: [результат]
- SSH: [результат]
- VMware Tools: [результат]
- Firewall: [результат]

### Agent нода 1 (k3s-agent-test-01)
- IP: 10.246.10.51
- Hostname: k3s-agent-test-01
- Cloud-init: [результат]
- Сеть: [результат]
- SSH: [результат]
- VMware Tools: [результат]

### Agent нода 2 (k3s-agent-test-02)
- IP: 10.246.10.52
- Hostname: k3s-agent-test-02
- Cloud-init: [результат]
- Сеть: [результат]
- SSH: [результат]
- VMware Tools: [результат]

### Сетевая связность
- Server ↔ Agent 1: [результат]
- Server ↔ Agent 2: [результат]
- Agent 1 ↔ Agent 2: [результат]

### Общий результат
- Template готов: [да/нет]
- Cloud-init работает: [да/нет]
- Сеть настроена: [да/нет]
- SSH доступен: [да/нет]
- VMware Tools активен: [да/нет]
EOF
```

---

## 🎯 Критерии успеха

### Template считается валидным когда:

1. **Все 3 тестовые VM** запустились успешно
2. **Cloud-init отработал** на всех нодах
3. **Статические IP** настроены корректно
4. **Hostname** установлен правильно
5. **DNS** работает на всех нодах
6. **Интернет** доступен на всех нодах
7. **SSH** доступен на всех нодах
8. **VMware Tools** активен на всех нодах
9. **Сетевая связность** между всеми нодами
10. **Отсутствуют K8s компоненты** на всех нодах

### Дополнительные проверки:

- **Firewall** настроен корректно
- **Время** синхронизировано (NTP)
- **Локализация** настроена
- **Пользователь** k8s-admin создан
- **Права sudo** настроены

---

## 🚨 Troubleshooting

### Проблема: Cloud-init не отрабатывает

**Симптомы:**
- Статический IP не применяется
- Hostname не устанавливается
- SSH не настраивается

**Решение:**
1. Проверьте логи: `cat /var/log/cloud-init.log`
2. Проверьте статус: `cloud-init status`
3. Проверьте настройки cloud-init в vSphere UI
4. Перезапустите cloud-init: `sudo cloud-init clean --logs && sudo cloud-init init`

### Проблема: Сеть не работает

**Симптомы:**
- IP не назначается
- Нет подключения к интернету
- Ноды не видят друг друга

**Решение:**
1. Проверьте настройки netplan: `cat /etc/netplan/01-static-ip.yaml`
2. Примените настройки: `sudo netplan apply`
3. Перезапустите сеть: `sudo systemctl restart systemd-networkd`
4. Проверьте подключение к NSX-T segment

### Проблема: SSH недоступен

**Симптомы:**
- Не удаётся подключиться по SSH
- Таймаут подключения
- Отказ в доступе

**Решение:**
1. Проверьте статус SSH: `sudo systemctl status ssh`
2. Проверьте порты: `sudo netstat -tlnp | grep :22`
3. Проверьте firewall: `sudo ufw status`
4. Проверьте настройки пользователя в cloud-init

---

## 📋 Чек-лист валидации

### Перед валидацией

- [ ] Template создан и готов
- [ ] Cloud-init файлы подготовлены
- [ ] Хэши паролей сгенерированы
- [ ] Тестовые VM созданы

### После валидации

- [ ] Все 3 тестовые VM запущены
- [ ] Cloud-init отработал на всех нодах
- [ ] Сеть настроена корректно
- [ ] SSH доступен на всех нодах
- [ ] Сетевая связность между нодами
- [ ] Отсутствуют K8s компоненты
- [ ] VMware Tools активен
- [ ] Отчёт о валидации создан

### Очистка после валидации

- [ ] Тестовые VM выключены
- [ ] Тестовые VM удалены
- [ ] Customization specs удалены
- [ ] Template готов к использованию

---

## 🎉 Финальная проверка

Template считается готовым к использованию когда:

1. **Все проверки пройдены** успешно
2. **Отчёт о валидации** создан
3. **Тестовые VM удалены**
4. **Template готов** для создания k3s нод

**Следующий шаг:** Использование Template для создания k3s кластера!

---

**Создано:** 2025-10-24
**AI-агент:** VM Template Specialist
**Цель:** Валидированный Template для k3s кластера
