# –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–±–æ—Ç—ã —Å SSH –≤ k3s Template

> **–î–∞—Ç–∞:** 2025-10-24
> **–¶–µ–ª—å:** –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å SSH –≤ Template –∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö VM

---

## üéØ –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–±—ä—è—Å–Ω—è–µ—Ç **–ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Ä–∞–±–æ—Ç—ã —Å SSH** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Template –∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ VM –¥–ª—è k3s –∫–ª–∞—Å—Ç–µ—Ä–∞.

### ‚ö†Ô∏è –í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å

- **Template:** SSH –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ VM:** SSH –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ cloud-init
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥–∞—è VM –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ SSH –∫–ª—é—á–∏

---

## üîß –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–±–æ—Ç—ã —Å SSH

### –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ Template

#### –ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ–º:
```bash
# –ù–ï —É–¥–∞–ª—è–µ–º SSH –∫–ª—é—á–∏ —Ö–æ—Å—Ç–∞ –≤ Template
sudo rm -f /etc/ssh/ssh_host_*  # ‚ùå –ù–ï –ù–£–ñ–ù–û!
```

#### –ß—Ç–æ –¥–µ–ª–∞–µ–º:
```bash
# –û—Å—Ç–∞–≤–ª—è–µ–º SSH –∫–∞–∫ –µ—Å—Ç—å –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
# Cloud-init –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è SSH –ø—Ä–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
```

**–ü–æ—á–µ–º—É:** Template –Ω—É–∂–µ–Ω –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### –≠—Ç–∞–ø 2: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ VM

#### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
```bash
# Cloud-init –ø—Ä–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏:
# 1. –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ SSH –∫–ª—é—á–∏ —Ö–æ—Å—Ç–∞
# 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ SSH –∫–ª—é—á–∏
# 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è k8s-admin
# 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–∞—Ä–æ–ª—å admin
```

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ cloud-init:
```yaml
# –í cloud-init —Ñ–∞–π–ª–∞—Ö:
ssh_deletekeys: true                    # –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏
ssh_genkeytypes: ['rsa', 'ecdsa', 'ed25519']  # –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ
ssh_pwauth: true                       # –†–∞–∑—Ä–µ—à–∏—Ç—å –ø–∞—Ä–æ–ª–∏
disable_root: true                     # –ó–∞–ø—Ä–µ—Ç–∏—Ç—å root
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å SSH

### –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–π

–ö–∞–∂–¥–∞—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è VM –ø–æ–ª—É—á–∞–µ—Ç:
- **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ SSH –∫–ª—é—á–∏ —Ö–æ—Å—Ç–∞** (rsa, ecdsa, ed25519)
- **–£–Ω–∏–∫–∞–ª—å–Ω—ã–π machine-id**
- **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ SSH –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º

```bash
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å k8s-admin —Å–æ–∑–¥–∞—ë—Ç—Å—è cloud-init
# –ü–∞—Ä–æ–ª—å: admin (–¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
# SSH –∫–ª—é—á–∏: –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ cloud-init
```

---

## üìã –ü–æ—à–∞–≥–æ–≤–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ Template

1. **–°–æ–∑–¥–∞–π—Ç–µ VM** —Å Ubuntu 24.04 LTS
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSH** (–æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å)
3. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç** `prepare-vm-template.sh`
4. **–ù–ï —É–¥–∞–ª—è–π—Ç–µ SSH –∫–ª—é—á–∏** –≤ —Å–∫—Ä–∏–ø—Ç–µ
5. **–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ Template**

### –®–∞–≥ 2: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ VM

1. **–ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ VM** –∏–∑ Template
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ cloud-init** –≤ vSphere UI
3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ VM**
4. **Cloud-init –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –Ω–∞—Å—Ç—Ä–æ–∏—Ç SSH

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π VM
ssh k8s-admin@[IP-–∞–¥—Ä–µ—Å]
# –ü–∞—Ä–æ–ª—å: admin

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –∫–ª—é—á–µ–π
sudo ls -la /etc/ssh/ssh_host_*
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–æ–≤—ã–µ –∫–ª—é—á–∏

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
id k8s-admin
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
```

---

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: SSH –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–∏—á–∏–Ω—ã:**
- Cloud-init –Ω–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cloud-init
- –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ cloud-init
cloud-init status

# –ï—Å–ª–∏ cloud-init –Ω–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª:
sudo cloud-init clean --logs
sudo cloud-init init

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH
sudo systemctl status ssh
sudo systemctl restart ssh
```

### –ü—Ä–æ–±–ª–µ–º–∞: SSH –∫–ª—é—á–∏ –Ω–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å

**–ü—Ä–∏—á–∏–Ω—ã:**
- Cloud-init –Ω–µ —É–¥–∞–ª–∏–ª —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ssh_deletekeys

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –†—É—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–ª—é—á–µ–π
sudo rm -f /etc/ssh/ssh_host_*

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–π
sudo ssh-keygen -A

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ SSH
sudo systemctl restart ssh
```

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç

### Template –≥–æ—Ç–æ–≤ –∫–æ–≥–¥–∞:
- [ ] SSH —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- [ ] Cloud-init –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è VMware
- [ ] SSH –∫–ª—é—á–∏ –ù–ï —É–¥–∞–ª–µ–Ω—ã –≤ Template
- [ ] –°–∫—Ä–∏–ø—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω

### –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è VM –≥–æ—Ç–æ–≤–∞ –∫–æ–≥–¥–∞:
- [ ] SSH –¥–æ—Å—Ç—É–ø–µ–Ω —Å –Ω–æ–≤—ã–º–∏ –∫–ª—é—á–∞–º–∏
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å k8s-admin —Å–æ–∑–¥–∞–Ω
- [ ] –ü–∞—Ä–æ–ª—å admin —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Cloud-init –æ—Ç—Ä–∞–±–æ—Ç–∞–ª —É—Å–ø–µ—à–Ω–æ

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:

1. **Template:** SSH –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
2. **Cloud-init:** –£–ø—Ä–∞–≤–ª—è–µ—Ç SSH –ø—Ä–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥–∞—è VM –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏
4. **–î–æ—Å—Ç—É–ø:** k8s-admin:admin –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –≤—Ö–æ–¥–∞

### ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:

1. **Template:** –£–¥–∞–ª—è—Ç—å SSH –∫–ª—é—á–∏
2. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ SSH
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–ª—é—á–∏ –Ω–∞ –≤—Å–µ—Ö VM
4. **–î–æ—Å—Ç—É–ø:** –°–ª–æ–∂–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞

---

**–°–æ–∑–¥–∞–Ω–æ:** 2025-10-24
**AI-–∞–≥–µ–Ω—Ç:** VM Template Specialist
**–¶–µ–ª—å:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–±–æ—Ç—ã —Å SSH
