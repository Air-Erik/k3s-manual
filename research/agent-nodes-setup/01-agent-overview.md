# Обзор k3s Agent Nodes и процесса присоединения

> **Этап:** 1.2.1 - Agent Nodes Overview
> **Дата:** 2025-10-24
> **Статус:** 📚 Теоретическая база

---

## 📋 Что такое k3s Agent Node?

**k3s Agent Node** — это рабочая нода в кластере k3s, которая выполняет только задачи по запуску контейнеров и НЕ содержит компоненты управления кластером.

### Основные функции Agent ноды:

```yaml
Agent Node включает:
  ✅ kubelet          # Управление pods на ноде
  ✅ kube-proxy       # Сетевая маршрутизация services
  ✅ containerd       # Container runtime (встроен в k3s)
  ✅ Flannel CNI      # Pod networking (встроен)

Agent Node НЕ включает:
  ❌ API Server       # Только на Server нодах
  ❌ etcd            # Только на Server нодах
  ❌ Controller      # Только на Server нодах
  ❌ Scheduler       # Только на Server нодах
```

**Простыми словами:** Agent нода = "рабочая лошадка" для запуска приложений, получает команды от Server ноды.

---

## 🏗️ Архитектура: Server vs Agent

### Сравнение компонентов:

| Компонент | Server Node | Agent Node | Назначение |
|-----------|-------------|------------|------------|
| **API Server** | ✅ | ❌ | Kubernetes API endpoint |
| **etcd** | ✅ | ❌ | База данных кластера |
| **Controller Manager** | ✅ | ❌ | Управление ресурсами |
| **Scheduler** | ✅ | ❌ | Размещение pods |
| **kubelet** | ✅ | ✅ | Управление pods на ноде |
| **kube-proxy** | ✅ | ✅ | Service networking |
| **containerd** | ✅ | ✅ | Container runtime |
| **Flannel** | ✅ | ✅ | Pod networking (CNI) |

### Визуальная схема нашего кластера:

```
┌─────────────────────────────────────────────────────────────┐
│                 k3s Cluster Architecture                    │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────▼─────────┐
                    │   k3s-server-01   │
                    │   10.246.10.50    │
                    │                   │
                    │  ┌─────────────┐  │
                    │  │ API Server  │  │ ◄── kubectl подключается сюда
                    │  │ etcd        │  │
                    │  │ Controller  │  │
                    │  │ Scheduler   │  │
                    │  └─────────────┘  │
                    │  ┌─────────────┐  │
                    │  │ kubelet     │  │ ◄── Может запускать workloads
                    │  │ kube-proxy  │  │
                    │  │ containerd  │  │
                    │  └─────────────┘  │
                    └───────┬───────────┘
                            │ API calls
              ┌─────────────┼─────────────┐
              │             │             │
         ┌────▼────┐   ┌────▼────┐
         │ agent-01│   │ agent-02│
         │ .10.51  │   │ .10.52  │
         │         │   │         │
         │ ┌─────┐ │   │ ┌─────┐ │
         │ │kubel│ │   │ │kubel│ │ ◄── Только workload pods
         │ │proxy│ │   │ │proxy│ │
         │ │conta│ │   │ │conta│ │
         │ └─────┘ │   │ └─────┘ │
         └─────────┘   └─────────┘
```

**Ключевое отличие:**
- **Server:** Управляет кластером + может запускать workloads
- **Agent:** Только запускает workloads, управление получает от Server

---

## 🔄 Процесс присоединения Agent к кластеру

### Шаг 1: Подготовка
```bash
# На новой ноде должны быть:
✅ Ubuntu 24.04 с базовыми пакетами
✅ Сетевое подключение к Server (10.246.10.50:6443)
✅ Node-token из Server ноды
✅ Статический IP адрес
```

### Шаг 2: Команда установки
```bash
curl -sfL https://get.k3s.io | \
  K3S_URL=https://10.246.10.50:6443 \
  K3S_TOKEN=<node-token> \
  sh -s - agent \
  --node-ip <IP_ноды> \
  --node-name <имя_ноды>
```

### Шаг 3: Что происходит при выполнении

```yaml
1. Загрузка k3s binary:
   - Скачивается последняя stable версия k3s
   - Устанавливается в /usr/local/bin/k3s

2. Проверка подключения к Server:
   - Проверяется доступность https://10.246.10.50:6443
   - Валидируется node-token

3. Создание systemd service:
   - Создается /etc/systemd/system/k3s-agent.service
   - Включается автозапуск при boot

4. Запуск Agent компонентов:
   - kubelet подключается к API Server
   - kube-proxy настраивает сеть
   - containerd готов к запуску контейнеров

5. Регистрация ноды в кластере:
   - Server добавляет ноду в список
   - kubectl get nodes показывает новую ноду
```

### Шаг 4: Результат
- Agent нода появляется в `kubectl get nodes`
- Статус меняется с `NotReady` → `Ready` (~30 сек)
- Scheduler может размещать pods на новой ноде

---

## 🔑 Роль node-token в безопасности

### Что такое node-token?

**Node-token** — это секретный ключ, который:
- Генерируется автоматически при установке k3s Server
- Используется для аутентификации Agent нод при присоединении
- Находится в файле `/var/lib/rancher/k3s/server/node-token` на Server

### Формат token:
```
K10abcd1234567890::server:1234567890abcdef1234567890abcdef
│        │          │    │
│        │          │    └── Server secret (32 символа)
│        │          └── Тип: server
│        └── Random part
└── Префикс k3s
```

### Безопасность:
- ✅ **Односторонняя аутентификация:** Token проверяется только Server
- ✅ **Автоматическая ротация:** Token можно изменить через API
- ⚠️ **Полный доступ:** Token даёт право присоединить любую ноду
- 🔒 **Секретность:** НЕ коммитить в git, хранить в безопасном месте

---

## 🌐 Сетевое взаимодействие Server ↔ Agent

### Обязательные сетевые соединения:

#### Agent → Server (исходящие):
```yaml
Port 6443 (TCP):
  Назначение: Kubernetes API Server
  Протокол: HTTPS (TLS)
  Использование:
    - kubelet регистрация и heartbeat
    - Получение команд для pods
    - Отправка статуса ноды

Port 10250 (TCP):
  Назначение: kubelet API (на всех нодах)
  Протокол: HTTPS
  Использование:
    - Server может выполнять команды на Agent
    - kubectl logs, kubectl exec
```

#### Flannel (между всеми нодами):
```yaml
Port 8472 (UDP):
  Назначение: Flannel VXLAN
  Протокол: UDP/VXLAN
  Использование:
    - Inter-pod communication
    - Pod-to-pod networking между нодами
```

### Сетевая схема для нашей инфраструктуры:

```
Internet
    │
    ▼
NSX-T T1 Gateway (10.246.10.1)
    │
    ▼
k8s-zeon-dev-segment (10.246.10.0/24)
    │
    ├── Server: 10.246.10.50:6443  ◄── Agent подключаются сюда
    ├── Agent1: 10.246.10.51:10250 ◄── Server управляет
    └── Agent2: 10.246.10.52:10250 ◄── Server управляет

Flannel overlay:
    ├── Server: 10.42.0.x/24
    ├── Agent1: 10.42.1.x/24  ◄── Pod subnets
    └── Agent2: 10.42.2.x/24
```

### Проверка сетевой связности:
```bash
# С Agent ноды проверить доступность Server
ping 10.246.10.50
curl -k https://10.246.10.50:6443/version

# Проверить что порты открыты
telnet 10.246.10.50 6443
telnet 10.246.10.50 10250
```

---

## ⚡ Преимущества k3s Agent архитектуры

### 1. Простота развёртывания
- **Одна команда** для присоединения ноды
- **Автоматическая версия** (совпадает с Server)
- **Встроенные компоненты** (не нужно устанавливать CNI, runtime)

### 2. Минимальные ресурсы
```yaml
Agent Node требует:
  RAM: 512 МБ минимум (2 ГБ рекомендуется)
  CPU: 1 core минимум (2 cores рекомендуется)
  Disk: 20 ГБ минимум (40 ГБ рекомендуется)
  Network: 1 Гбит/с
```

### 3. Высокая доступность workload
- При падении одной Agent ноды, pods перемещаются на другие
- Server остаётся доступен для управления
- Добавление новых Agent нод без downtime

### 4. Горизонтальное масштабирование
```bash
# Добавить новую Agent ноду = 2 минуты
1. Клонировать VM
2. Установить k3s agent
3. kubectl get nodes - видим новую ноду
```

---

## 🎯 Готовность к установке

После изучения этого обзора, для установки Agent нод нужно:

### Предварительные требования:
- ✅ **k3s Server работает** на 10.246.10.50
- ✅ **Node-token получен** из `/var/lib/rancher/k3s/server/node-token`
- ✅ **2 VM готовы** с IP 10.246.10.51 и 10.246.10.52
- ✅ **SSH доступ** к Agent нодам
- ✅ **Сетевая связность** проверена

### Процесс установки:
1. **Получить node-token** с Server ноды
2. **SSH к Agent ноде**
3. **Выполнить команду установки** k3s agent
4. **Дождаться Ready статуса**
5. **Повторить для второй ноды**

### Проверка готовности кластера:
```bash
# На Server ноде
kubectl get nodes
# Должны видеть 3 ноды: 1 Server + 2 Agent

kubectl get pods -A
# Все системные pods в Running состоянии
```

---

## 🔍 Следующие шаги

**Теперь вы понимаете архитектуру k3s Agent нод!**

**Далее:**
- Этап 2: Получение node-token с Server ноды
- Этап 3: Клонирование VM для Agent нод
- Этап 4: Пошаговая установка k3s agent
- Этап 5: Валидация кластера

---

**k3s Agent = Простое присоединение рабочих нод к кластеру! 🚀**
